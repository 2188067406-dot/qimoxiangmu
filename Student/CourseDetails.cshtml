@using System.Text.Json
@using System.Linq
@using TeachingAI1.Models
@model TeachingAI1.ViewModels.CourseDetailsViewModel
@{
    var imageUrl = $"/images/course{Model.Id}.jpg";
}

@{
    ViewData["Title"] = Model.Course.Title;
}

<div class="container-fluid pt-4 pb-0 flex-grow-1 d-flex flex-column " >
    <div class="row g-4 flex-grow-1">
    <!-- 主布局：单 row，左右两列 -->
    <div class="row g-4"> <!-- 使用 g-4 控制列间距，更现代 -->

        <!-- 左侧：课程信息 + 内容 -->
        <div class="col-lg-8 d-flex flex-column" style="min-height: 0;">
            <!-- Course Header (固定高度 300px) -->
            <div class="card border-0 shadow-sm mb-4" style="max-height: 300px; overflow-y: auto;">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <a href="@Url.Action("Courses", "Student")" class="btn btn-sm btn-outline-primary me-3">
                            <i class="fas fa-arrow-left me-2"></i>Back to Courses
                        </a>
                        <h1 class="h2 mb-0">@Model.Course.Title</h1>
                    </div>
                    <p class="lead">@Model.Course.Description</p>
                    <div class="d-flex align-items-center mb-3">
                        <div class="instructor-info me-4">
                            <span class="text-muted">Instructor:</span>
                            <span class="fw-bold">@Model.Course.Instructor</span>
                        </div>
                        <div class="rating-info me-4">
                            <span class="text-muted">Rating:</span>
                            <span class="fw-bold">
                                <i class="fas fa-star text-warning"></i>
                                <i class="fas fa-star text-warning"></i>
                                <i class="fas fa-star text-warning"></i>
                                <i class="fas fa-star text-warning"></i>
                                <i class="fas fa-star-half-alt text-warning"></i>
                                4.5
                            </span>
                        </div>
                        <div class="students-info">
                            <span class="text-muted">Students:</span>
                            <span class="fw-bold">1,250+</span>
                        </div>
                    </div>
                    <div class="progress-container mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Your Progress</span>
                            <span>@Model.Course.Progress%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: @Model.Course.Progress%;" aria-valuenow="@Model.Course.Progress" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                    <div class="course-stats d-flex flex-wrap" style="margin-bottom: 0 !important;">
                        <div class="course-stat-item me-4">
                            <i class="fas fa-book-open me-2 text-primary"></i>
                            <span>@Model.Course.LessonsCompleted/@Model.LessonsTotal Lessons Completed</span>
                        </div>
                        <div class="course-stat-item me-4">
                            <i class="fas fa-clock me-2 text-primary"></i>
                            <span>@Model.Course.TimeLeft Remaining</span>
                        </div>
                        <div class="course-stat-item">
                            <i class="fas fa-calendar-alt me-2 text-primary"></i>
                            <span>Status: @Model.Course.Status</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Course Content -->
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h4 class="card-title mb-2">Course Content</h4>
                    <div class="accordion" id="courseModules">
                        @for (int i = 0; i < Model.Modules.Count; i++)
                        {
                            var module = Model.Modules[i];
                            var headerId = $"heading{i + 1}";
                            var collapseId = $"collapse{i + 1}";
                            var statusClass = module.Status switch
                            {
                                "Completed" => "text-success",
                                "In Progress" => "text-primary",
                                _ => "text-muted"
                            };
                            var isActive = module.Status == "In Progress";

                            <div class="accordion-item">
                                <h2 class="accordion-header" id="@headerId">
                                    <button class="accordion-button @(isActive ? "" : "collapsed")" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#@collapseId"
                                        aria-expanded="@(isActive ? "true" : "false")" aria-controls="@collapseId">
                                        <div class="w-100 d-flex justify-content-between align-items-center">
                                            <span>Module @(i + 1): @module.Title</span>
                                            <span class="badge rounded-pill @statusClass ms-2">@module.Status</span>
                                        </div>
                                    </button>
                                </h2>

                                <div id="@collapseId" class="accordion-collapse collapse @(isActive ? "show" : "")"
                                    aria-labelledby="@headerId" data-bs-parent="#courseModules">
                                    <div class="accordion-body">
                                        <p>@module.Description</p>

                                        @if (!string.IsNullOrEmpty(module.VideoUrl))
                                        {
                                            <div class="mb-3">
                                                <video controls playsinline preload="metadata"
                                                    style="width: 100%; height: auto; border-radius: 8px; background: #000;">
                                                    <source src="@module.VideoUrl" type="video/mp4" />
                                                    Your browser does not support the video tag.
                                                </video>
                                            </div>
                                        }

                                        <div class="module-progress mb-3">
                                            <div class="d-flex justify-content-between mb-1">
                                                <span>Progress</span>
                                                <span>@module.CompletedLessons / @module.LessonCount Lessons</span>
                                            </div>
                                            <div class="progress">
                                                <div class="progress-bar" role="progressbar"
                                                    style="width: @(module.LessonCount > 0 ? (module.CompletedLessons * 100 / module.LessonCount) : 0)%;"
                                                    aria-valuenow="@module.CompletedLessons"
                                                    aria-valuemin="0" aria-valuemax="@module.LessonCount">
                                                </div>
                                            </div>
                                        </div>

                                        <div class="lessons-list">
                                            @for (int j = 0; j < module.Lessons.Count; j++)
                                            {
                                                var lesson = module.Lessons[j];
                                                var isCompleted = lesson.IsCompleted;
                                                var isNext = !isCompleted && (j == module.CompletedLessons);

                                                <div class="lesson-item d-flex justify-content-between align-items-center p-2 border-bottom">
                                                    <div class="d-flex align-items-center">
                                                        @if (isCompleted)
                                                        {
                                                            <i class="fas fa-check-circle text-success me-2"></i>
                                                        }
                                                        else
                                                        {
                                                            <i class="far fa-circle text-muted me-2"></i>
                                                        }
                                                        <span>@lesson.Title</span>
                                                    </div>
                                                    <div>
                                                        @if (isCompleted)
                                                        {
                                                            <button class="btn btn-sm btn-outline-primary">Review</button>
                                                        }
                                                        else if (isNext)
                                                        {
                                                            <button class="btn btn-sm btn-primary">Continue</button>
                                                        }
                                                        else
                                                        {
                                                            <button class="btn btn-sm btn-outline-secondary" disabled>Locked</button>
                                                        }
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
            <!-- AI 智能练习区域 -->
            <div class="mt-5">
                <div class="p-4 border border-primary border-dashed rounded bg-light">
                    <h4>AI 智能练习</h4>
                    <div id="quizContent">正在生成题目...</div>
                    <button id="regenerateBtn" class="btn btn-outline-secondary mt-3" style="display:none;">
                        重新生成题目
                    </button>
                </div>
            </div>

            <!-- 结果展示区（初始隐藏） -->
            <div id="result" class="mt-4" style="display:none;">
                <div class="p-4 border rounded bg-light">
                    <h3>✅ 答案与解析</h3>
                    <div id="ai-response"></div>
                </div>
            </div>
        </div> <!-- end col-lg-8 -->

        <!-- 右侧：Preview + Resources + Assignments + Forum -->
        <div class="col-lg-4 d-flex flex-column" style="min-height: 0;">

            <!-- Course Preview -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <h4 class="card-title">Course Preview</h4>
                    @if (!string.IsNullOrEmpty(imageUrl))
                    {
                        <div class="course-cover mb-3">
                            <img src="@imageUrl" 
                                 class="img-fluid" 
                                 alt="@Model.Course.Title" 
                                 style="max-height: 300px; object-fit: cover;" />
                        </div>
                    }
                    <div class="course-preview-video mb-3">
                        <video id="mainVideo" controls playsinline preload="metadata"
                               style="width: 100%; height: auto; border-radius: 8px; background: #000;">
                            <source src="~/@(string.IsNullOrEmpty(Model.VideoPath) ? "videos/placeholder.mp4" : Model.VideoPath)" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>

                        <div class="mt-2 d-flex justify-content-end">
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                    <span id="speedLabel">1x</span>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" data-speed="0.5">0.5x</a></li>
                                    <li><a class="dropdown-item" href="#" data-speed="0.75">0.75x</a></li>
                                    <li><a class="dropdown-item active" href="#" data-speed="1">1x</a></li>
                                    <li><a class="dropdown-item" href="#" data-speed="1.25">1.25x</a></li>
                                    <li><a class="dropdown-item" href="#" data-speed="1.5">1.5x</a></li>
                                    <li><a class="dropdown-item" href="#" data-speed="2">2x</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="d-grid gap-2 mt-4">
                        <a asp-controller="Student" 
                           asp-action="WatchVideo" 
                           asp-route-id="@Model.Course.Id"
                           class="btn btn-primary">
                            <i class="fas fa-play-circle me-2"></i> Play Video
                        </a>
                        <button id="downloadBtn" class="btn btn-outline-primary">
                            <i class="fas fa-download me-2"></i>Download Materials
                        </button>
                    </div>
                </div>
            </div>

            <!-- Resources -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <h4 class="card-title mb-3">Resources</h4>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center p-3">
                            <div>
                                <i class="fas fa-file-pdf text-danger me-2"></i>
                                <span>Course Syllabus</span>
                            </div>
                            <a href="#" class="btn btn-sm btn-outline-primary">Download</a>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center p-3">
                            <div>
                                <i class="fas fa-file-alt text-primary me-2"></i>
                                <span>Study Guide</span>
                            </div>
                            <a href="#" class="btn btn-sm btn-outline-primary">Download</a>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center p-3">
                            <div>
                                <i class="fas fa-file-code text-success me-2"></i>
                                <span>Code Samples</span>
                            </div>
                            <a href="#" class="btn btn-sm btn-outline-primary">Download</a>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center p-3">
                            <div>
                                <i class="fas fa-file-powerpoint text-warning me-2"></i>
                                <span>Presentation Slides</span>
                            </div>
                            <a href="#" class="btn btn-sm btn-outline-primary">Download</a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Upcoming Assignments -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <h4 class="card-title mb-3">Upcoming Assignments</h4>
                    <div class="assignment-item p-3 mb-3 border rounded">
                        <div class="d-flex justify-content-between">
                            <h5 class="mb-1">Module Quiz</h5>
                            <span class="badge bg-warning">Due in 2 days</span>
                        </div>
                        <p class="text-muted mb-2">Module 3: Knowledge Representation</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-clock me-1"></i> Est. 30 min</span>
                            <a href="#" class="btn btn-sm btn-outline-primary">Start Quiz</a>
                        </div>
                    </div>
                    <div class="assignment-item p-3 border rounded">
                        <div class="d-flex justify-content-between">
                            <h5 class="mb-1">Final Project</h5>
                            <span class="badge bg-info">Due in 2 weeks</span>
                        </div>
                        <p class="text-muted mb-2">Course Project</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-clock me-1"></i> Est. 5 hours</span>
                            <a href="#" class="btn btn-sm btn-outline-secondary">View Details</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Discussion Forum -->
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h4 class="card-title mb-3">Discussion Forum</h4>
                    <p class="text-muted">Join the conversation with your instructor and fellow students.</p>
                    <div class="forum-stats d-flex justify-content-between mb-3">
                        <div class="forum-stat text-center">
                            <h5>24</h5>
                            <span class="text-muted">Topics</span>
                        </div>
                        <div class="forum-stat text-center">
                            <h5>156</h5>
                            <span class="text-muted">Posts</span>
                        </div>
                        <div class="forum-stat text-center">
                            <h5>3</h5>
                            <span class="text-muted">Unread</span>
                        </div>
                    </div>
                    <div class="d-grid">
                        <a href="#" class="btn btn-outline-primary">View Forum</a>
                    </div>
                </div>
            </div>

        </div> <!-- end col-lg-4 -->
    </div>
</div>

@section Scripts {
<script>
document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const courseId = urlParams.get('id') || 
                    document.querySelector('input[name="courseId"]')?.value || 
                    1;

    const quizContent = document.getElementById('quizContent');
    const regenerateBtn = document.getElementById('regenerateBtn');

    async function generateQuiz() {
        quizContent.innerHTML = '<div class="text-muted">AI 正在生成题目，请稍候...</div>';
        regenerateBtn.style.display = 'none';
        document.getElementById('result').style.display = 'none';

        try {
            const res = await fetch(`/Course/GenerateQuizQuestions?courseId=${courseId}`);
            const data = await res.json();

            if (data.success && data.questions) {
                let html = '<form id="dynamicQuizForm">';
                data.questions.forEach((q, i) => {
                    html += `<div class="question mb-4 p-3 border rounded"><h5>${i + 1}. ${q.questionText}</h5>`;
                    q.options.forEach(opt => {
                        html += `
                            <div class="form-check">
                                <input class="form-check-input" type="radio" 
                                    name="answers[${i}]" value="${opt.value}" 
                                    id="q${i}_opt${opt.value}">
                                <label class="form-check-label" for="q${i}_opt${opt.value}">
                                    ${opt.value}. ${opt.text}
                                </label>
                            </div>`;
                    });
                    html += '</div>';
                });
                html += `<button type="submit" class="btn btn-success mt-3">提交答案</button></form>`;
                quizContent.innerHTML = html;

                // 绑定表单提交
                document.getElementById('dynamicQuizForm').addEventListener('submit', async (e) => {
                    e.preventDefault();

                    // 收集所有选中的答案（name="answers" 的 radio）
                    const selectedAnswers = Array.from(document.querySelectorAll('input[name="answers"]:checked'))
                                                  .map(input => input.value);

                    // 如果某些题没答，补空字符串（保持顺序）
                    const fullAnswers = [];
                    let answerIndex = 0;
                    for (let i = 0; i < data.questions.length; i++) {
                        const radioName = `q${i}_opt`;
                        const answered = document.querySelector(`input[name="answers"][id^="${radioName}"]:checked`);
                        if (answered) {
                            fullAnswers.push(answered.value);
                        } else {
                            fullAnswers.push(""); // 未作答
                        }
                    }

                    // 构造 FormData
                    const formData = new FormData();
                    formData.append('QuizQuestionsJson', JSON.stringify(data.questions)); // ⚠️ 注意大小写！
                    fullAnswers.forEach(ans => {
                        formData.append('answers', ans); // 多次 append 同一个 key
                    });

                    // 提交到 StudentController
                    const resultRes = await fetch('/Student/SubmitAnswers', {
                        method: 'POST',
                        body: formData // 不要设 Content-Type！让浏览器自动设置 boundary
                    });

                    if (resultRes.ok) {
                        const resultHtml = await resultRes.text();
                        document.open();
                        document.write(resultHtml);
                        document.close();
                    } else {
                        alert('提交失败，请重试。');
                    }
                });

                regenerateBtn.style.display = 'inline-block';
            } else {
                quizContent.innerHTML = `<div class="alert alert-warning">${data.message || '出题失败，请重试。'}</div>`;
                regenerateBtn.style.display = 'inline-block';
            }
        } catch (error) {
            quizContent.innerHTML = `<div class="alert alert-danger">网络错误：${error.message}</div>`;
            regenerateBtn.style.display = 'inline-block';
        }
    }

    regenerateBtn?.addEventListener('click', (e) => {
        e.preventDefault();
        generateQuiz();
    });

    generateQuiz();
});
</script>
}

    @if (ViewBag.ShowResult != null && ViewBag.ShowResult == true)
    {
        <script>
            document.querySelectorAll('.explanation').forEach(el => el.style.display = 'block');
        </script>
    }
</div> 

@section Styles {
    <style>
        .course-stats {
            margin-bottom: 0px;
        }
        
        .course-stat-item {
            margin-bottom: 10px;
        }
        
        .accordion-button:not(.collapsed) {
            background-color: rgba(67, 97, 238, 0.1);
            color: #4361ee;
        }
        
        .lesson-item:hover {
            background-color: #f8f9fa;
        }
        
        .module-progress {
            margin-bottom: 15px;
        }
        
        .forum-stat h5 {
            margin-bottom: 0;
            color: #4361ee;
        }

        /* 视频容器美化 */
        .course-preview-video video {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-height: 300px;
            object-fit: contain;
        }
    </style>
}

